<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loom Pro V15 (2Kè¶…æ¸…ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f5f5f7; 
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.08);
            --text-main: #1d1d1f; 
            --text-sub: #86868b;  
            --accent: #0071e3;    
            --danger: #ff3b30;    
            --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-color); 
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .dock {
            position: absolute; top: 24px; z-index: 100;
            display: flex; align-items: center; gap: 8px; padding: 8px 14px;
            background: var(--glass-bg); 
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); 
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            transition: border-color 0.3s;
        }
        
        body.recording .dock { border-color: rgba(255, 59, 48, 0.3); }

        .divider { width: 1px; height: 18px; background: rgba(0,0,0,0.1); margin: 0 4px; }

        button, select {
            background: transparent; border: none; 
            color: var(--text-main); font-size: 13px; font-weight: 500;
            padding: 8px 12px; border-radius: 10px; cursor: pointer; 
            display: flex; align-items: center; gap: 5px; transition: all 0.2s;
        }
        
        button:hover:not(:disabled) { background: rgba(0,0,0,0.05); }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-primary { background: var(--accent) !important; color: #fff !important; box-shadow: 0 2px 10px rgba(0,113,227,0.3); }
        .btn-record { background: rgba(255, 59, 48, 0.1) !important; color: var(--danger) !important; font-weight: 600; }
        .btn-record:hover:not(:disabled) { background: var(--danger) !important; color: #fff !important; }
        .btn-stop { background: #1d1d1f !important; color: #fff !important; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-toggle.active { background: #e8e8ed !important; color: #000 !important; font-weight: 600; }
        .btn-reset { color: var(--accent); font-size: 12px; }

        .select-wrap { position: relative; }
        select { 
            appearance: none; background: transparent; border: 1px solid rgba(0,0,0,0.1); 
            padding-right: 26px; color: var(--text-main); font-weight: 500;
        }
        .arrow { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; pointer-events: none; color: var(--text-sub); }

        /* ç”»å¸ƒåŒºåŸŸ */
        .viewport {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            padding: 40px; padding-top: 80px;
        }

        .canvas-box {
            position: relative; 
            /* CSS åªæ˜¯æ˜¾ç¤ºå¤§å°ï¼Œä¸å½±å“å½•åˆ¶æ¸…æ™°åº¦ */
            max-height: 80vh; max-width: 90vw;
            background: #000; 
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15); 
            overflow: hidden; cursor: grab; 
            transition: box-shadow 0.3s, border-color 0.3s;
            border: 4px solid transparent;
        }
        .canvas-box:active { cursor: grabbing; }
        body.recording .canvas-box { border-color: var(--danger); box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.2); }

        canvas { width: 100%; height: 100%; display: block; }

        /* æç¤ºå±‚ */
        .tip-layer { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.2); border-left-color: var(--accent);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
            margin-bottom: 15px; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .grid-lines {
            position: absolute; inset: 0; opacity: 0; transition: opacity 0.3s;
            background-image: linear-gradient(rgba(255,255,255,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.3) 1px, transparent 1px);
            background-size: 33.3% 33.3%;
        }
        .canvas-box:active .grid-lines { opacity: 1; }
        .drag-tip {
            margin-top: auto; margin-bottom: 20px;
            background: rgba(0,0,0,0.6); color: #fff; padding: 8px 16px; 
            border-radius: 20px; font-size: 13px; font-weight: 500;
            backdrop-filter: blur(10px); opacity: 0.9; 
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar { 
            position: fixed; bottom: 15px; font-size: 12px; color: var(--text-sub); 
            display: flex; gap: 8px; align-items: center;
            background: rgba(255,255,255,0.5); padding: 4px 10px; border-radius: 20px;
        }
        .badge { padding: 2px 6px; border-radius: 4px; background: #e5e5ea; color: var(--text-main); font-weight: 600; }
        .badge.hd { background: #e3f2fd; color: #0071e3; border: 1px solid rgba(0,113,227,0.2); }
        
        .hidden { display: none; }
        .hidden-stream { position: fixed; top:0; left:0; width:1px; height:1px; opacity:0.01; pointer-events:none; }
    </style>
</head>
<body>

    <div class="dock" id="dock">
        <button id="initBtn" class="btn-primary">ğŸ“¡ åˆå§‹åŒ–(4K)</button>
        <div class="divider"></div>
        
        <div class="select-wrap">
            <select id="ratioSelect" disabled>
                <option value="1.777">16:9 (å®½å±)</option>
                <option value="0.5625" selected>9:16 (æŠ–éŸ³)</option>
                <option value="0.75">3:4 (å°çº¢ä¹¦)</option>
                <option value="1">1:1 (æ–¹å½¢)</option>
            </select>
            <span class="arrow">â–¼</span>
        </div>

        <button id="resetBtn" class="btn-reset" disabled>âŸ² å›ä¸­</button>

        <div class="divider"></div>
        <button id="camToggle" class="btn-toggle active" disabled>å¤´åƒ</button>
        <button id="filterBtn" class="btn-toggle" disabled>ç¾é¢œ</button>
        <div class="divider"></div>
        <button id="recBtn" class="btn-record" disabled>ğŸ”´ å½•åˆ¶</button>
        <button id="stopBtn" class="btn-stop" style="display:none;">â¹ åœæ­¢</button>
    </div>

    <div class="viewport">
        <div id="canvasContainer" class="canvas-box" style="aspect-ratio: 9/16;">
            <canvas id="mainCanvas"></canvas>
            <div class="tip-layer">
                <div class="loading-spinner" id="spinner"></div>
                <div class="grid-lines"></div>
                <div id="countdown" style="font-size:120px; font-weight:800; color:#fff; display:none; text-shadow:0 10px 30px rgba(0,0,0,0.5);">3</div>
                <div class="drag-tip" id="dragTip">åˆå§‹åŒ–åå¯æ‹–æ‹½è°ƒæ•´æ„å›¾</div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="badge hd">2K/4K Ready</div>
        <div id="formatTag" class="badge">Format</div>
        <span id="statusText">ç­‰å¾…åˆå§‹åŒ–...</span>
    </div>

    <video id="vScreen" class="hidden-stream" autoplay playsinline muted></video>
    <video id="vCam" class="hidden-stream" autoplay playsinline muted></video>

    <script>
        const $ = id => document.getElementById(id);
        const canvas = $('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- æ ¸å¿ƒé…ç½® ---
        // åŸºç¡€åˆ†è¾¨ç‡æå‡è‡³ 2K (2560px)
        // å¦‚æœä½ çš„ç”µè„‘æ€§èƒ½å¼ºï¼Œå¯ä»¥æ”¹æˆ 3840 (4K)
        const BASE_WIDTH = 2560; 

        const state = {
            ready: false, recording: false,
            ratio: 0.5625, 
            canvasW: 1080, canvasH: 1920, // åŠ¨æ€è®¡ç®—
            screenOffsetX: 0, screenOffsetY: 0,
            camEnabled: true, filterMode: 0,
            camX: 50, camY: 1600, camSize: 300,
            camDragging: false, isDraggingScreen: false,
            lastMouseX: 0, lastMouseY: 0,
            audioLevel: 0
        };
        
        let recorder, chunks = [], audioCtx, analyser, dataArray;

        // 1. æ ¼å¼æ£€æµ‹
        (function checkSupport() {
            const types = ['video/mp4;codecs=avc1', 'video/mp4', 'video/webm;codecs=vp9'];
            for(let t of types) {
                if(MediaRecorder.isTypeSupported(t)) {
                    state.mimeType = t; 
                    $('formatTag').innerText = t.includes('mp4') ? "MP4" : "WebM";
                    return;
                }
            }
            state.mimeType = 'video/webm';
        })();

        // 2. åˆ†è¾¨ç‡è®¡ç®— (é«˜æ¸…æ ¸å¿ƒ)
        $('ratioSelect').onchange = (e) => {
            state.ratio = parseFloat(e.target.value);
            updateCanvasSize();
            resetLayout();
        };

        function updateCanvasSize() {
            if(state.ratio >= 1) { 
                // æ¨ªå±æ¨¡å¼ï¼šå®½åŸºå‡†
                state.canvasW = BASE_WIDTH; 
                state.canvasH = BASE_WIDTH / state.ratio; 
            } else { 
                // ç«–å±æ¨¡å¼ï¼šé«˜åŸºå‡† (é˜²æ­¢ç«–å±åˆ†è¾¨ç‡è¿‡ä½)
                // ä¾‹å¦‚ 9:16ï¼Œé«˜åº¦è®¾ä¸º BASE_WIDTH (2560)ï¼Œå®½åº¦è‡ªåŠ¨ç®—
                state.canvasH = BASE_WIDTH; 
                state.canvasW = BASE_WIDTH * state.ratio; 
            }
            
            canvas.width = state.canvasW;
            canvas.height = state.canvasH;
            
            // CSS aspect-ratio ç”¨äºæ˜¾ç¤ºæ¯”ä¾‹ï¼Œä¸å½±å“ç‰©ç†åˆ†è¾¨ç‡
            $('canvasContainer').style.aspectRatio = `${state.canvasW}/${state.canvasH}`;
            $('statusText').innerText = `è¶…æ¸…åˆ†è¾¨ç‡: ${Math.round(state.canvasW)}x${Math.round(state.canvasH)}`;
        }
        // åˆå§‹æ‰§è¡Œ
        updateCanvasSize();

        function resetLayout() {
            state.screenOffsetX = 0;
            state.screenOffsetY = 0;
            // æ‘„åƒå¤´ç›¸å¯¹å¤§å° (å é«˜åº¦çš„ 18%)
            state.camSize = state.canvasH * 0.18;
            state.camX = state.canvasW - state.camSize - 50;
            state.camY = state.canvasH - state.camSize - 50;
        }
        $('resetBtn').onclick = resetLayout;

        // 3. åˆå§‹åŒ– (è¯·æ±‚4Kä¿¡å·)
        $('initBtn').onclick = async () => {
            try {
                $('spinner').style.display = 'block';
                $('dragTip').innerText = "æ­£åœ¨è·å–é«˜æ¸…ä¿¡å·...";

                // å…³é”®ï¼šè¯·æ±‚ 4K ç†æƒ³åˆ†è¾¨ç‡
                const displayConstraints = { 
                    video: { 
                        width: { ideal: 3840 }, 
                        height: { ideal: 2160 }, 
                        frameRate: 60 
                    }, 
                    audio: true 
                };

                const sStream = await navigator.mediaDevices.getDisplayMedia(displayConstraints);
                const vScreen = $('vScreen');
                vScreen.srcObject = sStream;
                await vScreen.play();

                const cStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 1920 }, height: { ideal: 1080 } }, 
                    audio: true 
                });
                const vCam = $('vCam');
                vCam.srcObject = cStream;
                await vCam.play();

                audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(cStream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 32;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                state.ready = true;
                $('initBtn').style.display = 'none';
                $('recBtn').disabled = false;
                $('ratioSelect').disabled = false;
                $('camToggle').disabled = false;
                $('filterBtn').disabled = false;
                $('resetBtn').disabled = false;
                $('spinner').style.display = 'none';
                $('dragTip').innerText = "ğŸ‘† å·¦å³æ‹–æ‹½ç”»é¢è°ƒæ•´æ„å›¾";
                
                resetLayout();
                loop();
            } catch(e) { 
                alert("åˆå§‹åŒ–å¤±è´¥: " + e.message); $('spinner').style.display = 'none';
            }
        };

        // 4. æ¸²æŸ“å¾ªç¯
        function loop() {
            requestAnimationFrame(loop);
            if(!state.ready) return;

            if(analyser) { analyser.getByteFrequencyData(dataArray); state.audioLevel = dataArray.reduce((a,b)=>a+b,0)/dataArray.length; }

            const W = state.canvasW; const H = state.canvasH;
            ctx.clearRect(0,0,W,H);
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,W,H); 

            const vScreen = $('vScreen');
            if(vScreen.readyState >= 2 && vScreen.videoWidth > 0) {
                const vw = vScreen.videoWidth; const vh = vScreen.videoHeight;
                
                // Cover æ¨¡å¼ï¼šå¡«æ»¡
                const scale = Math.max(W / vw, H / vh);
                const drawW = vw * scale;
                const drawH = vh * scale;
                
                // è®¡ç®—åæ ‡
                let x = (W - drawW) / 2 + state.screenOffsetX;
                let y = (H - drawH) / 2 + state.screenOffsetY;
                
                // è¾¹ç•Œé™åˆ¶
                const minX = W - drawW; const minY = H - drawH;
                if (drawW > W) x = Math.max(minX, Math.min(0, x)); else x = (W - drawW) / 2;
                if (drawH > H) y = Math.max(minY, Math.min(0, y)); else y = (H - drawH) / 2;

                ctx.drawImage(vScreen, x, y, drawW, drawH);
            }

            if(state.camEnabled && $('vCam').readyState >= 2) drawCam(ctx);
        }

        function drawCam(ctx) {
            const { camX, camY, camSize, audioLevel, filterMode } = state;
            const r = camSize / 2; const cx = camX + r; const cy = camY + r;

            ctx.save();
            // å…‰åœˆ
            const vol = audioLevel / 40;
            if(vol > 0.1) {
                ctx.beginPath(); ctx.arc(cx, cy, r + vol*15, 0, Math.PI*2);
                ctx.fillStyle = `rgba(0, 113, 227, ${0.3+vol*0.2})`; ctx.fill(); 
            }
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 20; ctx.shadowOffsetY = 5;
            ctx.clip();

            if(filterMode === 1) ctx.filter = 'contrast(1.1) saturate(1.1)';
            
            const vCam = $('vCam');
            const min = Math.min(vCam.videoWidth, vCam.videoHeight);
            ctx.drawImage(vCam, (vCam.videoWidth-min)/2, (vCam.videoHeight-min)/2, min, min, camX, camY, camSize, camSize);
            
            ctx.filter = 'none'; ctx.strokeStyle = "#fff"; ctx.lineWidth = camSize*0.03; ctx.stroke();
            ctx.restore();
        }

        // æ‹–æ‹½é€»è¾‘
        const box = $('canvasContainer');
        box.onmousedown = (e) => {
            const rect = box.getBoundingClientRect();
            // å…³é”®ï¼šæ ¹æ®å®é™…åˆ†è¾¨ç‡è®¡ç®—ç¼©æ”¾æ¯”
            const scaleX = state.canvasW / rect.width; 
            const scaleY = state.canvasH / rect.height;
            
            const mx = (e.clientX - rect.left) * scaleX;
            const my = (e.clientY - rect.top) * scaleY;
            const cx = state.camX + state.camSize/2;
            const cy = state.camY + state.camSize/2;
            
            if(state.camEnabled && Math.hypot(mx-cx, my-cy) < state.camSize/2) state.camDragging = true;
            else state.isDraggingScreen = true;
            state.lastMouseX = e.clientX; state.lastMouseY = e.clientY;
        };

        window.onmousemove = (e) => {
            if(!state.camDragging && !state.isDraggingScreen) return;
            const rect = box.getBoundingClientRect();
            const scaleX = state.canvasW / rect.width; 
            const scaleY = state.canvasH / rect.height;
            const dx = (e.clientX - state.lastMouseX) * scaleX;
            const dy = (e.clientY - state.lastMouseY) * scaleY;

            if(state.camDragging) { state.camX += dx; state.camY += dy; } 
            else if (state.isDraggingScreen) { state.screenOffsetX += dx; state.screenOffsetY += dy; }
            state.lastMouseX = e.clientX; state.lastMouseY = e.clientY;
        };
        window.onmouseup = () => { state.camDragging = false; state.isDraggingScreen = false; };

        // å½•åˆ¶é€»è¾‘
        $('recBtn').onclick = () => {
            let c = 3; $('countdown').innerText = c; $('countdown').style.display = 'block';
            const t = setInterval(()=> {
                c--; if(c>0) $('countdown').innerText = c;
                else { clearInterval(t); $('countdown').style.display = 'none'; startRec(); }
            }, 1000);
        };
        
        function startRec() {
            chunks = []; const stream = canvas.captureStream(30); 
            const tracks = [];
            if($('vScreen').srcObject) tracks.push(...$('vScreen').srcObject.getAudioTracks());
            if($('vCam').srcObject) tracks.push(...$('vCam').srcObject.getAudioTracks());
            if(tracks.length) stream.addTrack(tracks[0]);
            
            // å…³é”®ï¼šæé«˜ç ç‡è‡³ 12Mbps
            recorder = new MediaRecorder(stream, {
                mimeType: state.mimeType, 
                videoBitsPerSecond: 12000000 
            });
            
            recorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
            recorder.onstop = () => {
                const blob = new Blob(chunks, {type: state.mimeType}); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `LoomPro_HQ_${Date.now()}.mp4`; a.click();
                document.body.classList.remove('recording');
            };
            recorder.start(); 
            document.body.classList.add('recording');
            $('recBtn').style.display = 'none'; $('stopBtn').style.display = 'flex';
            
            $('ratioSelect').disabled = true; $('resetBtn').disabled = true;
        }
        
        $('stopBtn').onclick = () => { 
            recorder.stop(); 
            $('recBtn').style.display = 'flex'; $('stopBtn').style.display = 'none';
            $('ratioSelect').disabled = false; $('resetBtn').disabled = false;
        };

        $('camToggle').onclick = (e) => { state.camEnabled = !state.camEnabled; e.target.classList.toggle('active'); };
        $('filterBtn').onclick = (e) => { state.filterMode = state.filterMode ? 0 : 1; e.target.classList.toggle('active'); };

    </script>
</body>
</html>